definitions:
  steps:
    - step: &staticAnalysis
        name: "Sonarqube step"
        oidc: true
        image: sonarqube:lts
        script:
          - echo "Sonarqube analysis goes here."

    - step: &unitTesting
        name: "Unit testing step"
        oidc: true
        image: maven:3.8.3-openjdk-17
        script:
          # Show role is base ec2 runnerr
          - echo $(aws sts get-caller-identity)
          - echo "Unit testing goes here"

    - step: &compile
        name: "Compilation step"
        image: maven:3.8.3-openjdk-17
        artifacts:
          - "**.jar"
        script:
          - echo "'mvn clean package' goes here"

    - step: &containerization
        name: "Containerization step"
        image: maven:3.8.3-openjdk-17
        services:
          - docker
        script:
          - echo "Docker containerization goes here"

    - step: &pushToCodeArtifact
        name: "Push to code artifact step"
        image: maven:3.8.3-openjdk-17
        script:
          - echo "Push of container to AWS CodeArtifact goes here"

    - step: &deploy
        name: "Deploy step"
        oidc: true
        image: bitnami/kubectl:latest
        script:
          - echo "AWS EKS deployment goes here"

    - step: &postDeployCheck
        name: "Post deploy check step"
        oidc: true
        image: bitnami/kubectl:latest
        script:
          - echo "Post-deploy check goes here"

    - step: &downstreamDevelop
        name: "Downstream to develop branch step"
        oidc: true
        image: bitnami/kubectl:latest
        script:
          - echo "Downstream to develop goes here"

    - step: &downstreamSit
        name: "Downstream to release branch step"
        oidc: true
        image: bitnami/kubectl:latest
        script:
          - echo "Downstream to release goes here"

pipelines:
  branches:
    develop:
      - step:
          <<: *compile
      - step:
          <<: *containerization
      - step:
          <<: *pushToCodeArtifact
      - step:
          <<: *deploy

    sit:
      - step:
          <<: *compile
      - step:
          <<: *containerization
      - step:
          <<: *pushToCodeArtifact
      - step:
          <<: *deploy
      - step:
          <<: *postDeployCheck
      - step:
          <<: *downstreamDevelop

    master:
      - step:
          <<: *compile
      - step:
          <<: *containerization
      - step:
          <<: *pushToCodeArtifact
      - step:
          <<: *deploy
      - step:
          <<: *postDeployCheck
      - step:
          <<: *downstreamSit
      - step:
          <<: *downstreamDevelop

  pull-requests:
    develop:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile

    sit:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile

    master:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile

    feature/**:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile

    bugfix/**:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile

    hotfix/**:
      - step:
          <<: *staticAnalysis
      - step:
          <<: *unitTesting
      - step:
          <<: *compile
